<script lang="ts">
	// Slots:
	/**
	 * @slot {{}} bcu-accordion-item-lead - Allows for an optional leading element, such as an icon.
	 * @slot {{}} bcu-accordion-item-summary - Provide the interactive summary of each item.
	 * @slot {{}} bcu-accordion-item-content - Provide the content content of each item.
	 */
	// Events:
	// FORWARDED: do not document these, breaks the type definition
	// DISPATCHED: document directly above the definition, like props (ex: paginator)

	import { getContext } from 'svelte';
	import { createEventDispatcher } from 'svelte/internal';
	import type { Writable } from 'svelte/store';
	import { slide } from 'svelte/transition';

	// Event Dispatcher
	const dispatch = createEventDispatcher();

	// Types
	import type { CssClasses } from '$lib';

	// Props (state)
	/** Set open by default on load. */
	export let open = false;
	// Props (a11y)
	/**
	 * Provide a unique input id. Auto-generated by default
	 * @type {string}
	 */
	export let id: string = String(Math.random());

	// Classes
	const cBase = '';
	const cControl = 'text-left w-full flex items-center space-x-4';
	const cControlCaret = 'fill-current w-3 transition-transform duration-[200ms]';
	const cPanel = '';

	// Context API
	/** Set the auto-collapse mode. */
	export let autocollapse: boolean = getContext('bcu-accordion-autocollapse');
	/** The writable store that houses the auto-collapse active item UUID. */
	export let active: Writable<string | null> = getContext('bcu-accordion-active');
	/** Set the drawer animation duration. */
	export let duration: number = getContext('bcu-accordion-duration');
	// ---
	/** Provide classes to set the accordion item padding styles. */
	export let padding: CssClasses = getContext('bcu-accordion-padding');
	/** Provide classes to set the accordion item hover styles. */
	export let hover: CssClasses = getContext('bcu-accordion-hover');
	/** Provide classes to set the accordion item rounded styles. */
	export let rounded: CssClasses = getContext('bcu-accordion-rounded');
	// ---
	/** Provide arbitrary classes to the trigger button region. */
	export let caretOpen: CssClasses = getContext('bcu-accordion-caretOpen');
	/** Provide arbitrary classes to content panel region. */
	export let caretClosed: CssClasses = getContext('bcu-accordion-caretClosed');
	// ---
	/** Provide arbitrary classes to the trigger button region. */
	export let regionControl: CssClasses = getContext('bcu-accordion-regionControl');
	/** Provide arbitrary classes to content panel region. */
	export let regionPanel: CssClasses = getContext('bcu-accordion-regionPanel');
	/** Provide arbitrary classes caret icon region. */
	export let regionCaret: CssClasses = getContext('bcu-accordion-regionCaret');

	// Change open behavior based on auto-collapse mode
	function setActive(event?: Event): void {
		if (autocollapse === true) {
			// Set item active
			active.set(id);
		} else {
			// Toggle Item on click
			open = !open;
		}
		// Always fire the toggle event
		onToggle(event);
	}

	function onToggle(event?: Event): void {
		const currentOpenState = autocollapse ? $active === id : open;
		/** @event {{ event: Event, id: string, open: boolean, autocollapse: boolean }} toggle - Fires when an accordion item is toggled. */
		dispatch('bcu-accordion-toggle', {
			event,
			id: `bcu-accordion-control-${id}`,
			open: currentOpenState,
			autocollapse
		});
	}

	// If auto-collapse mode enabled and item is set open, set as this item active
	if (autocollapse && open) setActive();

	// Reactive State
	$: if (open && autocollapse) setActive();
	$: openState = autocollapse ? $active === id : open;
	// Reactive Classes
	$: classesBase = `${cBase} ${$$props.class ?? ''}`;
	$: classesControl = `${cControl} ${padding} ${hover} ${rounded} ${regionControl}`;
	$: classesCaretState = openState ? caretOpen : caretClosed;
	$: classesControlCaret = `${cControlCaret} ${regionCaret} ${classesCaretState}`;
	$: classesPanel = `${cPanel} ${padding} ${rounded} ${regionPanel}`;
</script>

<!-- @component The Accordion child element. -->

<div class="bcu-accordion-item {classesBase}" data-testid="bcu-accordion-item">
	<!-- Control -->
	<button
		type="button"
		class="bcu-accordion-control {classesControl}"
		id="bcu-accordion-control-{id}"
		on:click={setActive}
		on:click
		on:keydown
		on:keyup
		on:keypress
		aria-expanded={openState}
		aria-controls="bcu-accordion-panel-{id}"
	>
		<!-- Lead -->
		{#if $$slots['bcu-lead']}
			<div class="bcu-accordion-lead">
				<slot name="bcu-lead" />
			</div>
		{/if}
		<!-- Summary -->
		<div class="bcu-accordion-summary flex-1">
			<slot name="bcu-summary">(summary)</slot>
		</div>
		<!-- Caret -->
		<div class="bcu-accordion-summary-caret {classesControlCaret}">
			<!-- SVG Caret -->
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
				<path
					d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"
				/>
			</svg>
		</div>
	</button>
	<!-- Panel -->
	{#if openState}
		<div
			class="bcu-accordion-panel {classesPanel}"
			id="bcu-accordion-panel-{id}"
			transition:slide|local={{ duration }}
			role="region"
			aria-hidden={!openState}
			aria-labelledby="bcu-accordion-control-{id}"
		>
			<slot name="bcu-content">(content)</slot>
		</div>
	{/if}
</div>
